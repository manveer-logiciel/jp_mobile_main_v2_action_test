name: Integration Build Preparation

on:
  workflow_dispatch:
    inputs:
      app_version:
        description: 'App Version (e.g., 3.37.2)'
        required: true
        type: string
      build_number:
        description: 'Build Number (e.g., 303700200)'
        required: true
        type: string
      build_platform:
        description: 'Select build platform'
        required: true
        type: choice
        options:
          - Both
          - Android
          - iOS
        default: Both

jobs:
  prepare-build:
    name: Prepare Build Environment
    runs-on: macos-latest
    permissions:
      contents: write
    outputs:
      app_version: ${{ steps.validation.outputs.app_version }}
      build_number: ${{ steps.validation.outputs.build_number }}
      build_platform: ${{ steps.validation.outputs.build_platform }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Validate Inputs
        id: validation
        run: |
          VERSION="${{ inputs.app_version }}"
          BUILD_NUMBER="${{ inputs.build_number }}"
          PLATFORM="${{ inputs.build_platform }}"
          
          echo "ðŸ” Validating inputs..."
          echo "ðŸ“‹ Version: $VERSION"
          echo "ðŸ”¢ Build Number: $BUILD_NUMBER"
          echo "ðŸ—ï¸ Platform: $PLATFORM"
          
          # Validate version format (x.y.z where x, y, z are numbers)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ERROR: Invalid version format. Expected format: x.y.z (e.g., 3.37.2)"
            exit 1
          fi
          
          # Validate build number is numeric
          if [[ ! $BUILD_NUMBER =~ ^[0-9]+$ ]]; then
            echo "âŒ ERROR: Build number must be numeric"
            exit 1
          fi
          
          echo "âœ… Input validation successful"
          
          # Set outputs for next steps
          echo "app_version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "build_platform=$PLATFORM" >> $GITHUB_OUTPUT
      
      - name: Update Version Files
        run: |
          VERSION="${{ steps.validation.outputs.app_version }}"
          BUILD_NUMBER="${{ steps.validation.outputs.build_number }}"
          
          echo "ðŸ”„ Updating version files..."
          
          # Update pubspec.yaml
          echo "ðŸ“ Updating pubspec.yaml: $VERSION+$BUILD_NUMBER"
          sed -i.bak "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" pubspec.yaml
          
          # Update global.dart
          echo "ðŸ“ Updating lib/common/libraries/global.dart: $VERSION"
          sed -i.bak "s/String appVersion = '[^']*';/String appVersion = '$VERSION';/" lib/common/libraries/global.dart
          
          # Update iOS marketing version
          echo "ðŸ“ Updating iOS marketing version: $VERSION"
          sed -i.bak "s/MARKETING_VERSION = [^;]*/MARKETING_VERSION = $VERSION/" ios/Runner.xcodeproj/project.pbxproj
          
          # Clean up backup files
          rm -f pubspec.yaml.bak lib/common/libraries/global.dart.bak ios/Runner.xcodeproj/project.pbxproj.bak
          
          echo "âœ… Version files updated successfully"
      
      - name: Commit Version Updates
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pubspec.yaml lib/common/libraries/global.dart ios/Runner.xcodeproj/project.pbxproj
          git commit -m "Update version to ${{ steps.validation.outputs.app_version }} (build ${{ steps.validation.outputs.build_number }})" || echo "No changes to commit"
          git push
      
      - name: Summary
        run: |
          echo "## ðŸŽ¯ Build Preparation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **App Version** | \`${{ steps.validation.outputs.app_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | \`${{ steps.validation.outputs.build_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platform** | \`${{ steps.validation.outputs.build_platform }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Updated Files" >> $GITHUB_STEP_SUMMARY
          echo "- \`pubspec.yaml\` - version: ${{ steps.validation.outputs.app_version }}+${{ steps.validation.outputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`lib/common/libraries/global.dart\` - appVersion: ${{ steps.validation.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- \`ios/Runner.xcodeproj/project.pbxproj\` - MARKETING_VERSION: ${{ steps.validation.outputs.app_version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Ready for build steps!**" >> $GITHUB_STEP_SUMMARY

  setup-flutter:
    name: Setup Flutter Environment
    needs: prepare-build
    runs-on: macos-latest
    permissions:
      contents: read
      packages: read
    outputs:
      flutter-cache-key: ${{ steps.flutter-cache.outputs.cache-primary-key }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'
          channel: 'stable'
          cache: true
      
      - name: Cache Flutter pub dependencies
        id: flutter-cache
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
            ~/Library/Caches/dart-pub
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}-
            ${{ runner.os }}-pub-
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Flutter Setup Summary
        run: |
          echo "## ðŸ’™ Flutter Environment Ready" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Flutter Version** | \`$(flutter --version | head -1)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dependencies** | âœ… Resolved |" >> $GITHUB_STEP_SUMMARY
          echo "| **Cache Status** | ${{ steps.flutter-cache.outputs.cache-hit && 'âœ… Cache Hit' || 'ðŸ”„ Cache Miss' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for platform builds!** ðŸš€" >> $GITHUB_STEP_SUMMARY

  build-aab:
    name: Building .aab
    needs: [prepare-build, setup-flutter]
    if: ${{ needs.prepare-build.outputs.build_platform == 'Android' || needs.prepare-build.outputs.build_platform == 'Both' }}
    runs-on: macos-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Cache Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Android/sdk
            ~/.android
          key: ${{ runner.os }}-android-sdk-${{ hashFiles('android/build.gradle', 'android/app/build.gradle') }}
          restore-keys: |
            ${{ runner.os }}-android-sdk-
      
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/daemon
            ~/Library/Caches/gradle
            android/.gradle
            android/app/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'android/gradle.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}-
            ${{ runner.os }}-gradle-
      
      - name: Setup Flutter (Restored from Cache)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'
          channel: 'stable'
          cache: true
      
      - name: Restore Flutter pub dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
            ~/Library/Caches/dart-pub
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}-
            ${{ runner.os }}-pub-
      
      - name: Cache Kotlin compilation
        uses: actions/cache@v4
        with:
          path: |
            ~/.konan
            ~/.kotlin
            ~/Library/Caches/kotlin
            android/build
            android/app/build/intermediates
          key: ${{ runner.os }}-kotlin-${{ hashFiles('**/*.kt', '**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-kotlin-
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      - name: Decode and create keystore file
        run: |
          echo "ðŸ” Creating keystore from base64 variable..."
          
          # Debug: Check if base64 variable is set and show its length
          if [ -z "${{ vars.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "âŒ ERROR: ANDROID_KEYSTORE_BASE64 variable is empty!"
            exit 1
          fi
          
          BASE64_LENGTH=$(echo "${{ vars.ANDROID_KEYSTORE_BASE64 }}" | wc -c)
          echo "ðŸ“ Base64 variable length: $BASE64_LENGTH characters"
          
          # Expected length for 2288 bytes should be around 3052 characters (2288 * 4/3 + padding)
          if [ "$BASE64_LENGTH" -lt 3000 ]; then
            echo "âš ï¸ WARNING: Base64 seems too short for a 2288-byte keystore"
          fi
          
          # Debug: Show first and last 50 characters of base64
          echo "ðŸ“‹ First 50 chars: $(echo "${{ vars.ANDROID_KEYSTORE_BASE64 }}" | head -c 50)"
          echo "ðŸ“‹ Last 50 chars: $(echo "${{ vars.ANDROID_KEYSTORE_BASE64 }}" | tail -c 50)"
          
          # Clean the base64 string (remove any potential whitespace/newlines) and decode
          echo "${{ vars.ANDROID_KEYSTORE_BASE64 }}" | tr -d '\n\r\t ' | base64 --decode > android/keystore.jks
          
          # Debug: Check if base64 decode command succeeded
          if [ $? -ne 0 ]; then
            echo "âŒ ERROR: Base64 decoding failed!"
            echo "This could indicate corrupted base64 content in the variable"
            exit 1
          fi
          
          # Verify the keystore file was created and has content
          if [ ! -f android/keystore.jks ]; then
            echo "âŒ ERROR: Keystore file was not created"
            exit 1
          fi
          
          # Check file size (should be > 0)
          KEYSTORE_SIZE=$(stat -f%z android/keystore.jks 2>/dev/null || stat -c%s android/keystore.jks 2>/dev/null || echo "0")
          echo "ðŸ“ Decoded keystore file size: $KEYSTORE_SIZE bytes"
          echo "ðŸ“ Expected keystore file size: 2288 bytes"
          
          if [ "$KEYSTORE_SIZE" -eq 0 ]; then
            echo "âŒ ERROR: Keystore file is empty - base64 decoding failed"
            exit 1
          fi
          
          if [ "$KEYSTORE_SIZE" -ne 2288 ]; then
            echo "âš ï¸ WARNING: Keystore size ($KEYSTORE_SIZE) doesn't match expected size (2288)"
            echo "This suggests the base64 encoding might be incorrect"
          fi
          
          # Set proper permissions
          chmod 600 android/keystore.jks
          echo "âœ… Keystore created and secured successfully"
      
      - name: Create key.properties
        run: |
          echo "ðŸ”‘ Creating key.properties..."
          echo "storePassword=${{ vars.ANDROID_STORE_PASSWORD }}" > android/key.properties
          echo "keyPassword=${{ vars.ANDROID_KEY_PASSWORD }}" >> android/key.properties
          echo "keyAlias=${{ vars.ANDROID_KEY_ALIAS }}" >> android/key.properties
          echo "storeFile=../keystore.jks" >> android/key.properties
          
          # Verify key.properties was created
          if [ ! -f android/key.properties ]; then
            echo "âŒ ERROR: key.properties was not created"
            exit 1
          fi
          
          echo "âœ… key.properties created successfully"
      
      - name: Verify keystore access
        run: |
          echo "ðŸ” Verifying keystore access..."
          
          # Try to list the keystore contents to verify password and alias
          if command -v keytool >/dev/null 2>&1; then
            echo "Testing keystore access with provided credentials..."
            
            # First, try to list all aliases without specifying one (this only needs store password)
            echo "ðŸ“‹ Listing all aliases in keystore..."
            keytool -list -keystore android/keystore.jks -storepass "${{ vars.ANDROID_STORE_PASSWORD }}" || {
              echo "âŒ ERROR: Cannot access keystore with store password"
              echo "Store password is definitely incorrect."
              exit 1
            }
            
            echo "âœ… Store password is correct! Now testing specific alias..."
            keytool -list -v -keystore android/keystore.jks -storepass "${{ vars.ANDROID_STORE_PASSWORD }}" -alias "${{ vars.ANDROID_KEY_ALIAS }}" || {
              echo "âŒ ERROR: Cannot access keystore with provided credentials"
              echo "This could indicate:"
              echo "  1. Incorrect ANDROID_STORE_PASSWORD"
              echo "  2. Incorrect ANDROID_KEY_ALIAS" 
              echo "  3. Corrupted keystore file"
              echo "  4. Invalid base64 encoding of keystore"
              exit 1
            }
            echo "âœ… Keystore verification successful"
          else
            echo "âš ï¸ keytool not available, skipping verification"
          fi
      
      - name: Update version in local.properties
        run: |
          echo "flutter.versionName=${{ needs.prepare-build.outputs.app_version }}" > android/local.properties
          echo "flutter.versionCode=${{ needs.prepare-build.outputs.build_number }}" >> android/local.properties
          echo "flutter.sdk=$FLUTTER_ROOT" >> android/local.properties
      
      - name: Build App Bundle
        run: flutter build appbundle --release
      
      - name: Upload App Bundle
        uses: actions/upload-artifact@v4
        with:
          name: android-app-bundle-${{ needs.prepare-build.outputs.app_version }}-${{ needs.prepare-build.outputs.build_number }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
      
      - name: Android Build Summary
        run: |
          echo "## ðŸ¤– Android Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ needs.prepare-build.outputs.app_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | \`${{ needs.prepare-build.outputs.build_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bundle Size** | \`$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **App Bundle ready for upload to Play Store**" >> $GITHUB_STEP_SUMMARY

  build-ipa:
    name: Building .ipa
    needs: [prepare-build, setup-flutter]
    if: ${{ needs.prepare-build.outputs.build_platform == 'iOS' || needs.prepare-build.outputs.build_platform == 'Both' }}
    runs-on: macos-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Setup Flutter (Restored from Cache)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'
          channel: 'stable'
          cache: true
      
      - name: Restore Flutter pub dependencies
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            ~/.pub-cache
            ~/Library/Caches/dart-pub
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}-
            ${{ runner.os }}-pub-
      
      - name: Cache CocoaPods dependencies
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      - name: Install CocoaPods
        run: |
          cd ios
          pod install
      
      - name: Build iOS (No Code Signing)
        run: flutter build ios --release --no-codesign
      
      - name: iOS Build Summary
        run: |
          echo "## ðŸ“± iOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | \`${{ needs.prepare-build.outputs.app_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | \`${{ needs.prepare-build.outputs.build_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "â„¹ï¸ **iOS build completed without code signing**" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“ **Note:** Code signing and .ipa generation requires Apple Developer certificates" >> $GITHUB_STEP_SUMMARY