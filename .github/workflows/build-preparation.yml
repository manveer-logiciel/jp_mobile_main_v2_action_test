name: Integration Build Preparation

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag (e.g., 3.37.2)'
        required: true
        type: string
      verify_release_tag:
        description: 'Verify Release Tag (must match above)'
        required: true
        type: string
      password:
        description: 'Password for secure operations'
        required: true
        type: string
      build_platform:
        description: 'Select build platform'
        required: true
        type: choice
        options:
          - Both
          - Android
          - iOS
        default: Both
      deploy_to_testing:
        description: 'Deploy to testing (Google Play Internal Testing / TestFlight)'
        required: false
        type: boolean
        default: true

env:
  FLUTTER_VERSION: '3.27.2'
  JAVA_VERSION: '17'

jobs:
  prepare-and-validate:
    name: Prepare & Validate Build
    runs-on: ubuntu-latest  # Use Ubuntu for faster validation
    permissions:
      contents: write
    outputs:
      release_tag: ${{ steps.validation.outputs.release_tag }}
      build_platform: ${{ steps.validation.outputs.build_platform }}
      should_build_android: ${{ steps.validation.outputs.should_build_android }}
      should_build_ios: ${{ steps.validation.outputs.should_build_ios }}
      deploy_to_testing: ${{ steps.validation.outputs.deploy_to_testing }}
      build_number: ${{ steps.validation.outputs.build_number }}
      version_name: ${{ steps.validation.outputs.version_name }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Fetch all history and tags
      
      - name: Validate Inputs & Set Outputs
        id: validation
        run: |
          RELEASE_TAG="${{ inputs.release_tag }}"
          VERIFY_RELEASE_TAG="${{ inputs.verify_release_tag }}"
          PASSWORD="${{ inputs.password }}"
          PLATFORM="${{ inputs.build_platform }}"
          
          echo "ðŸ” Validating inputs..."
          echo "ðŸ·ï¸ Release Tag: $RELEASE_TAG"
          echo "ðŸ” Password: [REDACTED]"
          echo "ðŸ—ï¸ Platform: $PLATFORM"
          
          # Validate release tags match
          if [[ "$RELEASE_TAG" != "$VERIFY_RELEASE_TAG" ]]; then
            echo "âŒ ERROR: Release tag and verify release tag do not match"
            echo "Release Tag: '$RELEASE_TAG'"
            echo "Verify Release Tag: '$VERIFY_RELEASE_TAG'"
            exit 1
          fi
          
          # Validate release tag format (semantic version without 'v' prefix)
          if [[ ! $RELEASE_TAG =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ ERROR: Invalid release tag format. Expected format: x.y.z (e.g., 3.37.2)"
            exit 1
          fi
          
          # Check if the tag exists in the repository
          echo "ðŸ” Checking if tag '$RELEASE_TAG' exists..."
          if ! git tag -l | grep -q "^$RELEASE_TAG$"; then
            echo "âŒ ERROR: Tag '$RELEASE_TAG' does not exist in the repository"
            echo "Available tags:"
            git tag -l | sort -V | tail -10
            echo ""
            echo "Please create the tag first using:"
            echo "  git tag $RELEASE_TAG"
            echo "  git push origin $RELEASE_TAG"
            exit 1
          fi
          
          echo "âœ… Tag '$RELEASE_TAG' exists in the repository"
          
          # Validate password is provided and not empty
          if [[ -z "$PASSWORD" ]]; then
            echo "âŒ ERROR: Password input is required"
            exit 1
          fi
          
          # Validate password against the stored secret
          STORED_PASSWORD="${{ secrets.RELEASE_PASSWORD }}"
          if [[ -z "$STORED_PASSWORD" ]]; then
            echo "âŒ ERROR: RELEASE_PASSWORD secret is not configured"
            echo "Please set the RELEASE_PASSWORD secret in repository settings"
            exit 1
          fi
          
          if [[ "$PASSWORD" != "$STORED_PASSWORD" ]]; then
            echo "âŒ ERROR: Invalid password provided"
            echo "The password does not match the stored RELEASE_PASSWORD secret"
            exit 1
          fi
          
          echo "ðŸ” Password verified successfully against stored secret"
          
          echo "âœ… Input validation successful"
          
          # Extract and validate build numbers from pubspec.yaml
          echo "ðŸ” Validating build numbers against existing releases..."
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2)
          VERSION_NAME=$(echo $PUBSPEC_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $PUBSPEC_VERSION | cut -d'+' -f2)
          
          echo "ðŸ“ Found version: $VERSION_NAME (build: $BUILD_NUMBER)"
          
          # Validate build number format
          if [[ ! $BUILD_NUMBER =~ ^[0-9]+$ ]]; then
            echo "âŒ ERROR: Invalid build number format '$BUILD_NUMBER'"
            echo "Build number must be numeric (e.g., 303800005)"
            exit 1
          fi
          
          # API validation using Fastlane
          echo "ðŸ” Validating build number against existing releases..."
          
          # Check Android builds if Android platform is selected
          if [[ "$PLATFORM" == "Android" || "$PLATFORM" == "Both" ]]; then
            echo "ðŸ¤– Checking Google Play Console for existing Android build $BUILD_NUMBER..."
            
            if [[ -n "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" ]]; then
              # Setup Google Play Console Service Account
              echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" | base64 --decode > android/play-console-service-account.json
              chmod 600 android/play-console-service-account.json
              
              # Setup Ruby and Fastlane for validation
              cd android
              gem install fastlane --no-document
              
              # Use supply command to check existing versions
              echo "Checking existing versions on Google Play Console..."
              if supply --track internal --json_key play-console-service-account.json --skip_upload_apk --skip_upload_aab --skip_upload_metadata --skip_upload_images --skip_upload_screenshots --version_code $BUILD_NUMBER 2>&1 | grep -q "already exists\|duplicate"; then
                echo "âŒ ERROR: Version code $BUILD_NUMBER already exists on Google Play Console Internal Testing track"
                rm -f play-console-service-account.json
                cd ..
                exit 1
              else
                echo "âœ… Version code $BUILD_NUMBER is available on Google Play Console"
              fi
              
              # Cleanup
              rm -f play-console-service-account.json
              cd ..
            else
              echo "âš ï¸ WARNING: GOOGLE_PLAY_SERVICE_ACCOUNT_JSON not configured, skipping Android validation"
            fi
          fi
          
          # Check iOS builds if iOS platform is selected
          if [[ "$PLATFORM" == "iOS" || "$PLATFORM" == "Both" ]]; then
            echo "ðŸ“± Checking TestFlight for existing iOS build $BUILD_NUMBER..."
            
            if [[ -n "${{ secrets.APP_STORE_CONNECT_API_KEY }}" && -n "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" && -n "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}" ]]; then
              # Setup iOS Fastlane for validation
              cd ios
              gem install fastlane --no-document
              
              # Set environment variables for Fastlane
              export APP_STORE_CONNECT_API_KEY_ID="${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}"
              export APP_STORE_CONNECT_API_ISSUER_ID="${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}"
              export APP_STORE_CONNECT_API_KEY_CONTENT="${{ secrets.APP_STORE_CONNECT_API_KEY }}"
              
              # Use pilot to check existing builds
              echo "Checking existing builds on TestFlight..."
              if pilot list --app_identifier "${{ secrets.IOS_BUNDLE_ID }}" 2>&1 | grep -q "Build $BUILD_NUMBER\|Version $BUILD_NUMBER"; then
                echo "âŒ ERROR: Build number $BUILD_NUMBER already exists on TestFlight"
                cd ..
                exit 1
              else
                echo "âœ… Build number $BUILD_NUMBER is available on TestFlight"
              fi
              
              cd ..
            else
              echo "âš ï¸ WARNING: App Store Connect API credentials not configured, skipping iOS validation"
            fi
          fi
          
          echo "âœ… Build number API validation completed"
          
          # Set outputs for next steps
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "build_platform=$PLATFORM" >> $GITHUB_OUTPUT
          echo "deploy_to_testing=${{ inputs.deploy_to_testing }}" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          
          # Set conditional build flags
          if [[ "$PLATFORM" == "Android" || "$PLATFORM" == "Both" ]]; then
            echo "should_build_android=true" >> $GITHUB_OUTPUT
          else
            echo "should_build_android=false" >> $GITHUB_OUTPUT
          fi
          
          if [[ "$PLATFORM" == "iOS" || "$PLATFORM" == "Both" ]]; then
            echo "should_build_ios=true" >> $GITHUB_OUTPUT
          else
            echo "should_build_ios=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validation Complete
        run: |
          # Extract build number for display
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2)
          BUILD_NUMBER=$(echo $PUBSPEC_VERSION | cut -d'+' -f2)
          
          echo "::notice title=Preparation Complete::âœ… Build validation and API verification completed successfully"
          echo ""
          echo "ðŸŽ‰ Build number $BUILD_NUMBER has been validated against existing releases!"
          if [[ "${{ inputs.build_platform }}" == "Android" || "${{ inputs.build_platform }}" == "Both" ]]; then
            echo "  âœ… Google Play Console â†’ Internal Testing"
          fi
          if [[ "${{ inputs.build_platform }}" == "iOS" || "${{ inputs.build_platform }}" == "Both" ]]; then
            echo "  âœ… App Store Connect â†’ TestFlight"
          fi

  setup-environment:
    name: Setup Build Environment
    needs: prepare-and-validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    outputs:
      flutter-cache-key: ${{ steps.cache-keys.outputs.flutter-cache-key }}
      android-cache-key: ${{ steps.cache-keys.outputs.android-cache-key }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Generate Cache Keys
        id: cache-keys
        run: |
          # Generate consistent cache keys for all jobs
          FLUTTER_KEY="flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock', '**/pubspec.yaml') }}"
          ANDROID_KEY="android-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/*.kt') }}-v2"
          
          echo "flutter-cache-key=$FLUTTER_KEY" >> $GITHUB_OUTPUT
          echo "android-cache-key=$ANDROID_KEY" >> $GITHUB_OUTPUT
          
          echo "ðŸ”‘ Flutter cache key: $FLUTTER_KEY"
          echo "ðŸ”‘ Android cache key: $ANDROID_KEY"
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Cache Flutter Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ steps.cache-keys.outputs.flutter-cache-key }}-android
          restore-keys: |
            flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}-
            flutter-${{ runner.os }}-${{ env.FLUTTER_VERSION }}-
            flutter-${{ runner.os }}-
      
      - name: Cache Android Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/daemon
            ~/.android
            android/.gradle
            android/app/.gradle
            android/build
            ~/.konan
            ~/.kotlin
            /home/runner/.gradle/caches/transforms-*
            /home/runner/.gradle/caches/build-cache-*
          key: ${{ steps.cache-keys.outputs.android-cache-key }}
          restore-keys: |
            android-${{ runner.os }}-${{ hashFiles('**/*.gradle*') }}-
            android-${{ runner.os }}-
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Environment Setup Complete
        run: |
          echo "::notice title=Environment Setup::âœ… Build environment setup completed successfully"

  setup-ios-environment:
    name: Setup iOS Build Environment
    needs: prepare-and-validate
    if: ${{ needs.prepare-and-validate.outputs.should_build_ios == 'true' }}
    runs-on: macos-15
    permissions:
      contents: read
      packages: read
    outputs:
      flutter-cache-key: ${{ steps.cache-keys.outputs.flutter-cache-key }}
      cocoapods-cache-key: ${{ steps.cache-keys.outputs.cocoapods-cache-key }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Generate Cache Keys
        id: cache-keys
        run: |
          # Generate consistent cache keys for iOS jobs
          FLUTTER_KEY="flutter-macOS-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock', '**/pubspec.yaml') }}"
          COCOAPODS_KEY="cocoapods-${{ runner.os }}-${{ hashFiles('**/Podfile.lock', 'ios/Runner.xcodeproj/project.pbxproj') }}-v2"
          
          echo "flutter-cache-key=$FLUTTER_KEY" >> $GITHUB_OUTPUT
          echo "cocoapods-cache-key=$COCOAPODS_KEY" >> $GITHUB_OUTPUT
          
          echo "ðŸ”‘ Flutter cache key: $FLUTTER_KEY"
          echo "ðŸ”‘ CocoaPods cache key: $COCOAPODS_KEY"
      
      - name: Cache Flutter Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/Library/Caches/dart-pub
            .dart_tool
          key: ${{ steps.cache-keys.outputs.flutter-cache-key }}-ios
          restore-keys: |
            flutter-macOS-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}-
            flutter-macOS-${{ env.FLUTTER_VERSION }}-
            flutter-macOS-
      
      - name: Cache CocoaPods & iOS Build
        uses: actions/cache@v4
        with:
          path: |
            ios/Pods
            ~/.cocoapods
            ~/Library/Caches/CocoaPods
            ios/build
            ios/.symlinks
          key: ${{ steps.cache-keys.outputs.cocoapods-cache-key }}
          restore-keys: |
            cocoapods-${{ runner.os }}-${{ hashFiles('**/Podfile.lock') }}-
            cocoapods-${{ runner.os }}-
      
      - name: Select Xcode 16.4
        run: |
          sudo xcode-select --switch /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version
          echo "Selected Xcode version:"
          xcode-select -p
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Install CocoaPods dependencies
        run: |
          echo "::notice title=iOS Setup::ðŸ“¦ Installing CocoaPods dependencies..."
          cd ios
          # Only run repo update if cache miss or force update needed
          if [ ! -d "Pods" ] || [ ! -f "Pods/Manifest.lock" ]; then
            pod install --repo-update
          else
            pod install
          fi
          echo "::notice title=iOS Setup::âœ… CocoaPods dependencies installed"
      
      - name: iOS Environment Setup Complete
        run: |
          echo "::notice title=iOS Environment Setup::âœ… iOS build environment setup completed successfully"

  build-android:
    name: Build Android (.aab)
    needs: [prepare-and-validate, setup-environment]
    if: ${{ needs.prepare-and-validate.outputs.should_build_android == 'true' }}
    runs-on: ubuntu-latest  # Use Ubuntu for Android builds - much faster!
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      # Restore cached dependencies from setup job
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Restore Flutter Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ needs.setup-environment.outputs.flutter-cache-key }}-android
          fail-on-cache-miss: true
      
      - name: Restore Android Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.gradle/daemon
            ~/.android
            android/.gradle
            android/app/.gradle
            android/build
            ~/.konan
            ~/.kotlin
            /home/runner/.gradle/caches/transforms-*
            /home/runner/.gradle/caches/build-cache-*
          key: ${{ needs.setup-environment.outputs.android-cache-key }}
          fail-on-cache-miss: true
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      # Verify Flutter dependencies are available
      - name: Verify Flutter dependencies
        run: |
          if [ ! -d ".dart_tool" ]; then
            echo "âš ï¸ Flutter dependencies not found in cache, running pub get..."
            flutter pub get
          else
            echo "âœ… Flutter dependencies restored from cache"
          fi
      
      # Batch Android configuration for better performance
      - name: Configure Android Build Environment
        run: |
          # Create keystore
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/keystore.jks
          chmod 600 android/keystore.jks
          
          # Create key.properties
          cat > android/key.properties << EOF
          storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=../keystore.jks
          EOF
          
          # Extract version info from pubspec.yaml (e.g., 3.38.0+303800005)
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2)
          VERSION_NAME=$(echo $PUBSPEC_VERSION | cut -d'+' -f1)
          VERSION_CODE=$(echo $PUBSPEC_VERSION | cut -d'+' -f2)
          
          echo "ðŸ“ Using Android version: $VERSION_NAME (code: $VERSION_CODE)"
          
          # Update local.properties
          cat > android/local.properties << EOF
          flutter.versionName=$VERSION_NAME
          flutter.versionCode=$VERSION_CODE
          flutter.sdk=$FLUTTER_ROOT
          EOF
          
          echo "âœ… Android build environment configured"
      
      - name: Build App Bundle
        run: |
          echo "::notice title=Android Build::ðŸ—ï¸ Building release app bundle..."
          flutter build appbundle --release \
            --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
            --split-debug-info=build/android/debug-info \
            --obfuscate
          echo "::notice title=Android Build::âœ… App bundle created successfully"
      
      - name: Upload App Bundle Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: android-app-bundle-${{ needs.prepare-and-validate.outputs.release_tag }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30
      
      - name: Android Build Summary
        run: |
          echo "## ðŸ¤– Android Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Tag** | \`${{ needs.prepare-and-validate.outputs.release_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bundle Size** | \`$(du -h build/app/outputs/bundle/release/app-release.aab | cut -f1)\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Build Environment" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Flutter** | \`${{ env.FLUTTER_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Java** | \`${{ env.JAVA_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Gradle** | \`$(cd android && ./gradlew --version | grep 'Gradle' | head -1 | cut -d' ' -f2)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Kotlin** | \`$(cd android && ./gradlew --version | grep 'Kotlin:' | cut -d' ' -f9)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Runner OS** | \`${{ runner.os }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target SDK** | \`$(grep 'compileSdk' android/app/build.gradle | head -1 | grep -o '[0-9]*')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Min SDK** | \`$(grep 'minSdk' android/app/build.gradle | head -1 | grep -o '[0-9]*')\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Android App Bundle built successfully**" >> $GITHUB_STEP_SUMMARY

  deploy-android:
    name: Deploy Android to Testing
    needs: [prepare-and-validate, build-android]
    if: ${{ needs.prepare-and-validate.outputs.should_build_android == 'true' && needs.prepare-and-validate.outputs.deploy_to_testing == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Download App Bundle Artifact
        uses: actions/download-artifact@v4
        with:
          name: android-app-bundle-${{ needs.prepare-and-validate.outputs.release_tag }}
          path: build/app/outputs/bundle/release/
      
      - name: Cache Ruby Dependencies & Fastlane
        uses: actions/cache@v4
        with:
          path: |
            android/vendor/bundle
            ~/.gem
            ~/.bundle
            android/.bundle
          key: ruby-fastlane-${{ runner.os }}-${{ hashFiles('android/Gemfile', 'android/Gemfile.lock') }}-v2
          restore-keys: |
            ruby-fastlane-${{ runner.os }}-${{ hashFiles('android/Gemfile') }}-
            ruby-fastlane-${{ runner.os }}-
      
      - name: Setup Ruby for Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: android
      
      - name: Setup Google Play Console Service Account
        run: |
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" | base64 --decode > android/play-console-service-account.json
          chmod 600 android/play-console-service-account.json
      
      - name: Deploy to Google Play Console Internal Testing
        run: |
          export AAB_FILE_PATH="$(pwd)/build/app/outputs/bundle/release/app-release.aab"
          cd android
          bundle exec fastlane deploy_internal
        env:
          SUPPLY_JSON_KEY_FILE: play-console-service-account.json
      
      - name: Android Deployment Summary
        run: |
          echo "## ðŸš€ Android Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **App Bundle deployed to Google Play Console Internal Testing**" >> $GITHUB_STEP_SUMMARY

  build-ios:
    name: Build iOS
    needs: [prepare-and-validate, setup-ios-environment]
    if: ${{ needs.prepare-and-validate.outputs.should_build_ios == 'true' }}
    runs-on: macos-15  # Use macOS-15 to support Xcode 16.4
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      # Restore cached dependencies from setup job
      - name: Restore Flutter Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.pub-cache
            ~/Library/Caches/dart-pub
            .dart_tool
          key: ${{ needs.setup-ios-environment.outputs.flutter-cache-key }}-ios
          fail-on-cache-miss: true
      
      - name: Restore CocoaPods Dependencies Cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ios/Pods
            ~/.cocoapods
            ~/Library/Caches/CocoaPods
            ios/build
            ios/.symlinks
          key: ${{ needs.setup-ios-environment.outputs.cocoapods-cache-key }}
          fail-on-cache-miss: true
      
      - name: Select Xcode 16.4
        run: |
          sudo xcode-select --switch /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version
          echo "Selected Xcode version:"
          xcode-select -p
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
      
      - name: Configure Git for private repos
        run: |
          TOKEN="${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}"
          git config --global url."https://x-access-token:${TOKEN}@github.com/".insteadOf "https://github.com/"
      
      # Verify Flutter and CocoaPods dependencies are available
      - name: Verify dependencies
        run: |
          if [ ! -d ".dart_tool" ]; then
            echo "âš ï¸ Flutter dependencies not found in cache, running pub get..."
            flutter pub get
          else
            echo "âœ… Flutter dependencies restored from cache"
          fi
          
          if [ ! -d "ios/Pods" ]; then
            echo "âš ï¸ CocoaPods dependencies not found in cache, running pod install..."
            cd ios && pod install
          else
            echo "âœ… CocoaPods dependencies restored from cache"
          fi
      
      - name: Configure Xcode Project for Manual Signing
        run: |
          echo "ðŸ”§ Configuring Xcode project for manual signing..."
          
          # Function to safely set plist value (add if doesn't exist, set if exists)
          safe_pbxproj_set() {
            local target_id="$1"
            local key="$2"
            local value="$3"
            
            if /usr/libexec/PlistBuddy -c "Print :objects:$target_id:buildSettings:$key" ios/Runner.xcodeproj/project.pbxproj >/dev/null 2>&1; then
              /usr/libexec/PlistBuddy -c "Set :objects:$target_id:buildSettings:$key $value" ios/Runner.xcodeproj/project.pbxproj
            else
              /usr/libexec/PlistBuddy -c "Add :objects:$target_id:buildSettings:$key string $value" ios/Runner.xcodeproj/project.pbxproj
            fi
          }
          
          # Configure main app (Runner target) - Debug, Release, Profile
          echo "ðŸ“± Configuring main app signing..."
          safe_pbxproj_set "97C147061CF9000F007C117D" "CODE_SIGN_STYLE" "Manual"
          safe_pbxproj_set "97C147071CF9000F007C117D" "CODE_SIGN_STYLE" "Manual"
          safe_pbxproj_set "249021D4217E4FDB00AE95B9" "CODE_SIGN_STYLE" "Manual"
          
          safe_pbxproj_set "97C147061CF9000F007C117D" "CODE_SIGN_IDENTITY" "Apple Distribution"
          safe_pbxproj_set "97C147071CF9000F007C117D" "CODE_SIGN_IDENTITY" "Apple Distribution"
          safe_pbxproj_set "249021D4217E4FDB00AE95B9" "CODE_SIGN_IDENTITY" "Apple Distribution"
          
          # Configure Share Extension target - Debug, Release, Profile
          echo "ðŸ“± Configuring Share Extension signing..."
          safe_pbxproj_set "E2B11C5528B6384500902FF7" "CODE_SIGN_STYLE" "Manual"
          safe_pbxproj_set "E2B11C5628B6384500902FF7" "CODE_SIGN_STYLE" "Manual"
          safe_pbxproj_set "E2B11C5728B6384500902FF7" "CODE_SIGN_STYLE" "Manual"
          
          safe_pbxproj_set "E2B11C5528B6384500902FF7" "CODE_SIGN_IDENTITY" "Apple Distribution"
          safe_pbxproj_set "E2B11C5628B6384500902FF7" "CODE_SIGN_IDENTITY" "Apple Distribution"
          safe_pbxproj_set "E2B11C5728B6384500902FF7" "CODE_SIGN_IDENTITY" "Apple Distribution"
          
          echo "âœ… Xcode project configured for manual signing (both main app and Share Extension)"
      
      
      # iOS Code Signing Setup
      - name: Setup iOS Code Signing
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_SHARE_EXTENSION_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_SHARE_EXTENSION_PROVISIONING_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          MAIN_PROFILE_PATH=$RUNNER_TEMP/main_app.mobileprovision
          SHARE_PROFILE_PATH=$RUNNER_TEMP/share_extension.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          
          # Import certificate and provisioning profiles from secrets
          echo -n "$IOS_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode -o $MAIN_PROFILE_PATH
          echo -n "$IOS_SHARE_EXTENSION_PROVISIONING_PROFILE_BASE64" | base64 --decode -o $SHARE_PROFILE_PATH
          
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          
          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH
          
          # Install provisioning profiles
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          
          # Extract profile information with streamlined error handling
          MAIN_PROFILE_UUID=$(security cms -D -i $MAIN_PROFILE_PATH | plutil -extract UUID xml1 -o - -- - | xmllint --xpath "//string/text()" - 2>/dev/null || security cms -D -i $MAIN_PROFILE_PATH | grep -A1 "UUID" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          SHARE_PROFILE_UUID=$(security cms -D -i $SHARE_PROFILE_PATH | plutil -extract UUID xml1 -o - -- - | xmllint --xpath "//string/text()" - 2>/dev/null || security cms -D -i $SHARE_PROFILE_PATH | grep -A1 "UUID" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          MAIN_PROFILE_NAME=$(security cms -D -i $MAIN_PROFILE_PATH | plutil -extract Name xml1 -o - -- - | xmllint --xpath "//string/text()" - 2>/dev/null || security cms -D -i $MAIN_PROFILE_PATH | grep -A1 "Name" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          SHARE_PROFILE_NAME=$(security cms -D -i $SHARE_PROFILE_PATH | plutil -extract Name xml1 -o - -- - | xmllint --xpath "//string/text()" - 2>/dev/null || security cms -D -i $SHARE_PROFILE_PATH | grep -A1 "Name" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          
          # Validate extracted values
          if [[ -z "$MAIN_PROFILE_UUID" ]] || [[ -z "$MAIN_PROFILE_NAME" ]] || [[ -z "$SHARE_PROFILE_UUID" ]] || [[ -z "$SHARE_PROFILE_NAME" ]]; then
            echo "âŒ ERROR: Failed to extract provisioning profile information"
            exit 1
          fi
          
          # Install profiles
          cp $MAIN_PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$MAIN_PROFILE_UUID.mobileprovision
          cp $SHARE_PROFILE_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$SHARE_PROFILE_UUID.mobileprovision
          
          # Update ExportOptions.plist
          cp ios/ExportOptions.plist ios/ExportOptions.plist.backup
          
          # Function to safely update plist values
          safe_plist_update() {
            local key="$1"
            local value="$2"
            if ! /usr/libexec/PlistBuddy -c "Set :provisioningProfiles:$key \"$value\"" ios/ExportOptions.plist 2>/dev/null; then
              /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:$key string \"$value\"" ios/ExportOptions.plist 2>/dev/null || return 1
            fi
          }
          
          # Update provisioning profiles in ExportOptions.plist
          safe_plist_update "${{ secrets.IOS_BUNDLE_ID }}" "$MAIN_PROFILE_NAME"
          safe_plist_update "${{ secrets.IOS_SHARE_EXTENSION_BUNDLE_ID }}" "$SHARE_PROFILE_NAME"
          
          # Basic bundle ID validation
          MAIN_BUNDLE_ID_FULL=$(security cms -D -i ~/Library/MobileDevice/Provisioning\ Profiles/$MAIN_PROFILE_UUID.mobileprovision | grep -A1 "application-identifier" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          MAIN_BUNDLE_ID=$(echo "$MAIN_BUNDLE_ID_FULL" | sed 's/^[^.]*\.//')
          
          if [[ "$MAIN_BUNDLE_ID" != "${{ secrets.IOS_BUNDLE_ID }}" ]]; then
            echo "âŒ ERROR: Bundle ID mismatch. Expected: ${{ secrets.IOS_BUNDLE_ID }}, Found: $MAIN_BUNDLE_ID"
            exit 1
          fi
          
          echo "âœ… iOS code signing setup complete"
          echo "::notice title=iOS Build::ðŸ” Code signing configured successfully"
      
      - name: Configure Provisioning Profile UUIDs in Xcode Project
        run: |
          echo "ðŸ”§ Setting provisioning profile UUIDs in Xcode project..."
          
          # Get the profile UUIDs that were extracted earlier
          MAIN_PROFILE_PATH=$RUNNER_TEMP/main_app.mobileprovision
          SHARE_PROFILE_PATH=$RUNNER_TEMP/share_extension.mobileprovision
          
          # Use the same robust extraction method as before
          MAIN_PROFILE_UUID=$(security cms -D -i $MAIN_PROFILE_PATH | plutil -extract UUID xml1 -o - -- - | xmllint --xpath "//string/text()" - 2>/dev/null || security cms -D -i $MAIN_PROFILE_PATH | grep -A1 "UUID" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          SHARE_PROFILE_UUID=$(security cms -D -i $SHARE_PROFILE_PATH | plutil -extract UUID xml1 -o - -- - | xmllint --xpath "//string/text()" - 2>/dev/null || security cms -D -i $SHARE_PROFILE_PATH | grep -A1 "UUID" | grep string | sed 's/.*<string>\(.*\)<\/string>.*/\1/' | head -1)
          
          # Validate the extracted UUIDs
          if [[ -z "$MAIN_PROFILE_UUID" ]] || [[ -z "$SHARE_PROFILE_UUID" ]]; then
            echo "âŒ ERROR: Failed to extract provisioning profile UUIDs for Xcode project configuration"
            echo "ðŸ“‹ Main profile UUID: '$MAIN_PROFILE_UUID'"
            echo "ðŸ“‹ Share profile UUID: '$SHARE_PROFILE_UUID'"
            exit 1
          fi
          
          echo "ðŸ“‹ Setting Main app profile UUID: $MAIN_PROFILE_UUID"
          echo "ðŸ“‹ Setting Share extension profile UUID: $SHARE_PROFILE_UUID"
          
          # Function to safely set plist value (add if doesn't exist, set if exists)
          safe_pbxproj_set() {
            local target_id="$1"
            local key="$2"
            local value="$3"
            
            if /usr/libexec/PlistBuddy -c "Print :objects:$target_id:buildSettings:$key" ios/Runner.xcodeproj/project.pbxproj >/dev/null 2>&1; then
              /usr/libexec/PlistBuddy -c "Set :objects:$target_id:buildSettings:$key $value" ios/Runner.xcodeproj/project.pbxproj
            else
              /usr/libexec/PlistBuddy -c "Add :objects:$target_id:buildSettings:$key string $value" ios/Runner.xcodeproj/project.pbxproj
            fi
          }
          
          # Set provisioning profile UUIDs for main app (Runner target) - Debug, Release, Profile
          echo "ðŸ“± Setting main app provisioning profile UUIDs..."
          safe_pbxproj_set "97C147061CF9000F007C117D" "PROVISIONING_PROFILE_SPECIFIER" "$MAIN_PROFILE_UUID"
          safe_pbxproj_set "97C147071CF9000F007C117D" "PROVISIONING_PROFILE_SPECIFIER" "$MAIN_PROFILE_UUID"
          safe_pbxproj_set "249021D4217E4FDB00AE95B9" "PROVISIONING_PROFILE_SPECIFIER" "$MAIN_PROFILE_UUID"
          
          # Set development team for main app
          safe_pbxproj_set "97C147061CF9000F007C117D" "DEVELOPMENT_TEAM" "${{ secrets.APPLE_TEAM_ID }}"
          safe_pbxproj_set "97C147071CF9000F007C117D" "DEVELOPMENT_TEAM" "${{ secrets.APPLE_TEAM_ID }}"
          safe_pbxproj_set "249021D4217E4FDB00AE95B9" "DEVELOPMENT_TEAM" "${{ secrets.APPLE_TEAM_ID }}"
          
          # Set provisioning profile UUIDs for Share Extension target - Debug, Release, Profile
          echo "ðŸ“± Setting Share Extension provisioning profile UUIDs..."
          safe_pbxproj_set "E2B11C5528B6384500902FF7" "PROVISIONING_PROFILE_SPECIFIER" "$SHARE_PROFILE_UUID"
          safe_pbxproj_set "E2B11C5628B6384500902FF7" "PROVISIONING_PROFILE_SPECIFIER" "$SHARE_PROFILE_UUID"
          safe_pbxproj_set "E2B11C5728B6384500902FF7" "PROVISIONING_PROFILE_SPECIFIER" "$SHARE_PROFILE_UUID"
          
          # Set development team for Share Extension
          safe_pbxproj_set "E2B11C5528B6384500902FF7" "DEVELOPMENT_TEAM" "${{ secrets.APPLE_TEAM_ID }}"
          safe_pbxproj_set "E2B11C5628B6384500902FF7" "DEVELOPMENT_TEAM" "${{ secrets.APPLE_TEAM_ID }}"
          safe_pbxproj_set "E2B11C5728B6384500902FF7" "DEVELOPMENT_TEAM" "${{ secrets.APPLE_TEAM_ID }}"
          
          echo "âœ… Provisioning profile UUIDs configured for both main app and Share Extension"
      
      - name: Update iOS Version
        run: |
          # Extract version info from pubspec.yaml (e.g., 3.38.0+303800005)
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2)
          VERSION=$(echo $PUBSPEC_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $PUBSPEC_VERSION | cut -d'+' -f2)
          
          echo "ðŸ“ Using iOS version: $VERSION (build: $BUILD_NUMBER)"
          
          # Function to safely set plist value (add if doesn't exist, set if exists)
          safe_plist_set() {
            local plist_file="$1"
            local key="$2"
            local value="$3"
            
            if /usr/libexec/PlistBuddy -c "Print :$key" "$plist_file" >/dev/null 2>&1; then
              /usr/libexec/PlistBuddy -c "Set :$key $value" "$plist_file"
            else
              /usr/libexec/PlistBuddy -c "Add :$key string $value" "$plist_file"
            fi
          }
          
          # Update Info.plist for main app
          echo "ðŸ“± Updating main app Info.plist..."
          safe_plist_set "ios/Runner/Info.plist" "CFBundleShortVersionString" "$VERSION"
          safe_plist_set "ios/Runner/Info.plist" "CFBundleVersion" "$BUILD_NUMBER"
          
          # Update Info.plist for share extension
          echo "ðŸ“± Updating share extension Info.plist..."
          safe_plist_set "ios/Share Extension/Info.plist" "CFBundleShortVersionString" "$VERSION"
          safe_plist_set "ios/Share Extension/Info.plist" "CFBundleVersion" "$BUILD_NUMBER"
          
          echo "âœ… iOS version updated successfully for main app and share extension"
      
      - name: Build iOS Archive
        run: |
          # Extract version info from pubspec.yaml (e.g., 3.38.0+303800005)
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | cut -d' ' -f2)
          VERSION=$(echo $PUBSPEC_VERSION | cut -d'+' -f1)
          BUILD_NUMBER=$(echo $PUBSPEC_VERSION | cut -d'+' -f2)
          
          echo "ðŸ“ Building iOS with version: $VERSION (build: $BUILD_NUMBER)"
          echo "::notice title=iOS Build::ðŸ—ï¸ Building iOS archive (.ipa)..."
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --build-name="$VERSION" \
            --build-number="$BUILD_NUMBER" \
            --dart-define=FLUTTER_WEB_AUTO_DETECT=true \
            --split-debug-info=build/ios/debug-info \
            --obfuscate
          
          # Quick validation of IPA creation
          if [ ! -f build/ios/ipa/*.ipa ]; then
            echo "âŒ ERROR: IPA file was not created"
            ls -la build/ios/ipa/ 2>/dev/null || echo "Directory does not exist"
            exit 1
          fi
          
          echo "âœ… IPA created: $(ls build/ios/ipa/*.ipa)"
          echo "ðŸ“¦ IPA file ready for TestFlight upload"
          echo "::notice title=iOS Build::âœ… IPA archive created successfully"
          
          # Verify IPA structure for TestFlight compatibility
          IPA_FILE=$(ls build/ios/ipa/*.ipa)
          echo "ðŸ” Verifying IPA structure..."
          unzip -l "$IPA_FILE" | head -20
      
      - name: Upload iOS App (.ipa) Artifact
        uses: actions/upload-artifact@v4
        if: always() && hashFiles('build/ios/ipa/*.ipa') != ''
        with:
          name: ios-app-${{ needs.prepare-and-validate.outputs.release_tag }}
          path: build/ios/ipa/*.ipa
          retention-days: 30
      
      - name: Cleanup Keychain
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
      
      - name: iOS Build Summary
        if: always()
        run: |
          echo "## ðŸ“± iOS Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Tag** | \`${{ needs.prepare-and-validate.outputs.release_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Bundle ID** | \`$(plutil -extract CFBundleIdentifier xml1 -o - ios/Runner/Info.plist | xmllint --xpath "//string/text()" - 2>/dev/null || echo '${{ secrets.IOS_BUNDLE_ID }}')\` |" >> $GITHUB_STEP_SUMMARY
          
          if [ -f build/ios/ipa/*.ipa ]; then
            echo "| **IPA Size** | \`$(du -h build/ios/ipa/*.ipa | cut -f1)\` |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| **Status** | âŒ IPA creation failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Build Environment" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Version |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Flutter** | \`${{ env.FLUTTER_VERSION }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Xcode** | \`$(xcodebuild -version | head -1 | cut -d' ' -f2)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **iOS SDK** | \`$(xcrun --show-sdk-version --sdk iphoneos)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **macOS SDK** | \`$(xcrun --show-sdk-version --sdk macosx)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **CocoaPods** | \`$(pod --version)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Runner OS** | \`${{ runner.os }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Min iOS Version** | \`$(plutil -extract MinimumOSVersion xml1 -o - ios/Runner/Info.plist | xmllint --xpath "//string/text()" - 2>/dev/null || grep 'IPHONEOS_DEPLOYMENT_TARGET' ios/Runner.xcodeproj/project.pbxproj | head -1 | grep -o '[0-9]*\.[0-9]*' || echo '12.0')\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Swift Version** | \`$(xcrun swift --version | head -1 | cut -d' ' -f4)\` |" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build/ios/ipa/*.ipa ]; then
            echo "âœ… **iOS app built successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **iOS build failed during IPA export. Check provisioning profiles and code signing configuration.**" >> $GITHUB_STEP_SUMMARY
          fi

  deploy-ios:
    name: Deploy iOS to Testing
    needs: [prepare-and-validate, build-ios]
    if: ${{ needs.prepare-and-validate.outputs.should_build_ios == 'true' && needs.prepare-and-validate.outputs.deploy_to_testing == 'true' }}
    runs-on: macos-15
    permissions:
      contents: read
      packages: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRIVATE_REPO_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main
      
      - name: Download iOS App Artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-app-${{ needs.prepare-and-validate.outputs.release_tag }}
          path: build/ios/ipa/
      
      - name: Cache Ruby Dependencies & Fastlane (iOS)
        uses: actions/cache@v4
        with:
          path: |
            ios/vendor/bundle
            ~/.gem
            ~/.bundle
            ios/.bundle
          key: ruby-fastlane-ios-${{ runner.os }}-${{ hashFiles('ios/Gemfile', 'ios/Gemfile.lock') }}-v2
          restore-keys: |
            ruby-fastlane-ios-${{ runner.os }}-${{ hashFiles('ios/Gemfile') }}-
            ruby-fastlane-ios-${{ runner.os }}-
      
      - name: Setup Ruby for Fastlane (iOS)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios
      
      - name: Deploy to TestFlight
        run: |
          # Find and validate IPA file
          IPA_FILES=(build/ios/ipa/*.ipa)
          if [ ! -f "${IPA_FILES[0]}" ]; then
            echo "âŒ ERROR: No IPA files found in build/ios/ipa/"
            ls -la build/ios/ipa/ || echo "Directory does not exist"
            exit 1
          fi
          
          if [ ${#IPA_FILES[@]} -gt 1 ]; then
            echo "âš ï¸  WARNING: Multiple IPA files found, using first one:"
            printf '%s\n' "${IPA_FILES[@]}"
          fi
          
          export IPA_FILE_PATH="$(pwd)/${IPA_FILES[0]}"
          echo "ðŸ“± Using IPA file: $IPA_FILE_PATH"
          
          cd ios
          bundle exec fastlane deploy_testflight
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_CONTENT: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      
      - name: iOS Deployment Summary
        run: |
          echo "## ðŸš€ iOS Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **iOS app deployed to TestFlight successfully**" >> $GITHUB_STEP_SUMMARY

  build-summary:
    name: Final Build Summary
    needs: [prepare-and-validate, build-android, build-ios, deploy-android, deploy-ios]
    if: always() && needs.prepare-and-validate.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Final Build Summary
        run: |
          echo "::notice title=Build Summary::ðŸ“Š Generating deployment summary..."
          
          echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create deployment status like in Laravel workflow
          echo "### ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job completion status with visual indicators
          echo "**Prepare & Validate Build**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.prepare-and-validate.result }}" == "success" ]]; then
            echo "```diff" >> $GITHUB_STEP_SUMMARY
            echo "+ âœ… Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "```diff" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Failed" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Android Build Status
          echo "**Build Android (.aab)**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.prepare-and-validate.outputs.should_build_android }}" == "true" ]]; then
            if [[ "${{ needs.build-android.result }}" == "success" ]]; then
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "+ âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            else
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "```yaml" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Android Deployment Status
          echo "**Deploy Android to Testing**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.prepare-and-validate.outputs.should_build_android }}" == "true" && "${{ needs.prepare-and-validate.outputs.deploy_to_testing }}" == "true" ]]; then
            if [[ "${{ needs.deploy-android.result }}" == "success" ]]; then
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "+ âœ… Deployed to Google Play Internal Testing" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            else
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "```yaml" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # iOS Build Status  
          echo "**Build iOS**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.prepare-and-validate.outputs.should_build_ios }}" == "true" ]]; then
            if [[ "${{ needs.build-ios.result }}" == "success" ]]; then
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "+ âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            else
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Build Failed" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "```yaml" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # iOS Deployment Status
          echo "**Deploy iOS to Testing**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.prepare-and-validate.outputs.should_build_ios }}" == "true" && "${{ needs.prepare-and-validate.outputs.deploy_to_testing }}" == "true" ]]; then
            if [[ "${{ needs.deploy-ios.result }}" == "success" ]]; then
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "+ âœ… Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            else
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "- âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "```yaml" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“‹ Build Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Tag** | \`${{ needs.prepare-and-validate.outputs.release_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platform** | \`${{ needs.prepare-and-validate.outputs.build_platform }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Deploy to Testing** | \`${{ needs.prepare-and-validate.outputs.deploy_to_testing }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [\`#${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`$(echo ${{ github.sha }} | cut -c1-7)\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          
          echo "::notice title=Build Summary::âœ… Deployment summary completed"
