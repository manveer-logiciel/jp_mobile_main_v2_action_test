name: Mobile App Build Orchestrator

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release Tag (e.g., 3.37.2)'
        required: true
        type: string
      verify_release_tag:
        description: 'Verify Release Tag (must match above)'
        required: true
        type: string
      password:
        description: 'Password for secure operations'
        required: true
        type: string
      build_platform:
        description: 'Select build platform'
        required: true
        type: choice
        options:
          - Both
          - Android
          - iOS
        default: Both

jobs:
  validate:
    name: Validate Build Parameters
    uses: ./.github/workflows/build-validation.yml
    with:
      release_tag: ${{ inputs.release_tag }}
      verify_release_tag: ${{ inputs.verify_release_tag }}
      password: ${{ inputs.password }}
      build_platform: ${{ inputs.build_platform }}
    secrets: inherit

  build-android:
    name: Build Android App
    needs: validate
    if: ${{ needs.validate.outputs.should_build_android == 'true' }}
    uses: ./.github/workflows/build-android.yml
    with:
      release_tag: ${{ needs.validate.outputs.release_tag }}
    secrets: inherit

  build-ios:
    name: Build iOS App
    needs: validate
    if: ${{ needs.validate.outputs.should_build_ios == 'true' }}
    uses: ./.github/workflows/build-ios.yml
    with:
      release_tag: ${{ needs.validate.outputs.release_tag }}
    secrets: inherit

  build-summary:
    name: Final Build Summary
    needs: [validate, build-android, build-ios]
    if: always() && needs.validate.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Final Build Summary
        run: |
          echo "::notice title=Build Summary::📊 Generating deployment summary..."
          
          echo "## 📦 Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create deployment status
          echo "### 🚀 Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Job completion status with visual indicators
          echo "**Validate Build Parameters**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.validate.result }}" == "success" ]]; then
            echo "```diff" >> $GITHUB_STEP_SUMMARY
            echo "+ ✅ Completed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          else
            echo "```diff" >> $GITHUB_STEP_SUMMARY
            echo "- ❌ Failed" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Android Build Status
          echo "**Build Android App**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.validate.outputs.should_build_android }}" == "true" ]]; then
            if [[ "${{ needs.build-android.result }}" == "success" ]]; then
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "+ ✅ Deployed to Google Play Internal Testing" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            else
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "- ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "```yaml" >> $GITHUB_STEP_SUMMARY
            echo "⏭️ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # iOS Build Status  
          echo "**Build iOS App**" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ needs.validate.outputs.should_build_ios }}" == "true" ]]; then
            if [[ "${{ needs.build-ios.result }}" == "success" ]]; then
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "+ ✅ Deployed to TestFlight" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            else
              echo "```diff" >> $GITHUB_STEP_SUMMARY
              echo "- ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
              echo "```" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "```yaml" >> $GITHUB_STEP_SUMMARY
            echo "⏭️ Skipped" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### 📋 Build Details" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Tag** | \`${{ needs.validate.outputs.release_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platform** | \`${{ needs.validate.outputs.build_platform }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Workflow Run** | [\`#${{ github.run_number }}\`](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | [\`$(echo ${{ github.sha }} | cut -c1-7)\`](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}) |" >> $GITHUB_STEP_SUMMARY
          
          echo "::notice title=Build Summary::✅ Deployment summary completed"
